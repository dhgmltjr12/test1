<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR 차량기록 시스템</title>

    <!-- QR 스캔 라이브러리 -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- SheetJS (엑셀 생성) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .hidden { display: none; }

        #scanner-area {
            width: 100%;
            max-width: 400px;
            margin: auto;
        }

        #reader {
            width: 100%;
            aspect-ratio: 1;
        }

        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            font-size: 16px;
        }

        button {
            background: #1976D2;
            color: white;
            border: none;
            border-radius: 8px;
        }

        button:active {
            background: #0F4C8A;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-top: 30px;
        }
    </style>
</head>
<body>

<h2>차량 정보 입력</h2>

<div id="input-area">
    <input type="text" id="carNum" placeholder="차량번호">
    <input type="text" id="driverName" placeholder="이름">
    <input type="text" id="phone" placeholder="연락처">
    <input type="text" id="ton" placeholder="톤수">

    <button onclick="startFirstScan()">입력 완료 & QR 스캔 시작</button>
</div>

<!-- QR 스캔 구역 -->
<div id="scanner-area" class="hidden">
    <div id="reader"></div>
    <button onclick="stopScan()">스캔 중지</button>
</div>

<!-- 하차지점 화면 -->
<div id="after-first" class="hidden">
    <h3>충수지점 스캔 완료</h3>
    <button onclick="editInfo()">입력정보 수정</button>
    <button onclick="startSecondScan()">하차지점 QR 스캔</button>
</div>

<!-- 최종 완료 -->
<div id="done-area" class="hidden">
    <h3>하차지점 스캔 완료</h3>
    <button onclick="downloadExcel()">엑셀 다운로드</button>
</div>


<script>
/* ---------------------------
   전역 변수
--------------------------- */
let html5QrcodeScanner = null;
let firstScanData = null;
let secondScanData = null;

/* ---------------------------
   스캐너 표시/숨김
--------------------------- */
function showScanner(on) {
    document.getElementById("scanner-area").style.display = on ? "block" : "none";
    window.scrollTo(0, 0);
}

/* ===========================
    1. 첫 번째 QR 스캔 시작
=========================== */
async function startFirstScan() {

    // 입력값 체크
    if (!carNum.value || !driverName.value || !phone.value || !ton.value) {
        alert("모든 정보를 입력하세요");
        return;
    }

    showScanner(true);

    /* ❗ Android-safe delay 패치(50ms) */
    await new Promise(res => setTimeout(res, 80));

    await startCamera("first");
}


/* ===========================
    2. 두 번째 QR 스캔 시작
=========================== */
async function startSecondScan() {
    showScanner(true);

    /* ❗ Android-safe delay 패치(80ms) */
    await new Promise(res => setTimeout(res, 80));

    await startCamera("second");
}


/* ---------------------------
   공통: 카메라 시작
   안드로이드 안정화 패치 포함
--------------------------- */
async function startCamera(mode) {

    if (html5QrcodeScanner) {
        try { await html5QrcodeScanner.stop(); } catch(e){}
    }

    html5QrcodeScanner = new Html5Qrcode("reader");

    /* ❗ Android-friendly 설정 */
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
    };

    /* ❗ 핵심 패치: facingMode 강제 대신 자동 탐색 */
    Html5Qrcode.getCameras().then(async devices => {

        const cameraId = devices[0].id; // 첫 번째 카메라 자동 선택

        try {
            await html5QrcodeScanner.start(
                { facingMode: "environment" },  // 안정 모드
                config,
                (decodedText) => onScanSuccess(decodedText, mode),
                (errorMessage) => {}
            );
        } catch (e) {
            alert("카메라 실행 오류: " + e);
        }

    }).catch(err => alert("카메라 장치를 찾을 수 없음: " + err));
}


/* ---------------------------
   스캔 성공 처리
--------------------------- */
async function onScanSuccess(text, mode) {

    const now = new Date().toLocaleString();

    if (mode === "first") {
        firstScanData = {
            carNum: carNum.value,
            driverName: driverName.value,
            phone: phone.value,
            ton: ton.value,
            step: "충수",
            qr: text,
            time: now
        };

        await stopScan();
        document.getElementById("after-first").classList.remove("hidden");
    }

    if (mode === "second") {
        secondScanData = {
            carNum: carNum.value,
            driverName: driverName.value,
            phone: phone.value,
            ton: ton.value,
            step: "하차",
            qr: text,
            time: now
        };

        await stopScan();
        document.getElementById("done-area").classList.remove("hidden");
    }

    showScanner(false);
}


/* ---------------------------
   스캔 중지
--------------------------- */
async function stopScan() {
    if (html5QrcodeScanner) {
        try {
            await html5QrcodeScanner.stop();
        } catch (e) {}
    }
    showScanner(false);
}


/* ---------------------------
   입력정보 수정 기능
--------------------------- */
function editInfo() {
    document.getElementById("input-area").scrollIntoView({behavior: "smooth"});
}


/* ---------------------------
   Excel 다운로드
--------------------------- */
function downloadExcel() {
    const wb = XLSX.utils.book_new();

    const data = [
        ["차량번호", "이름", "연락처", "톤수", "단계", "QR내용", "스캔시간"],
        [firstScanData.carNum, firstScanData.driverName, firstScanData.phone,
         firstScanData.ton, firstScanData.step, firstScanData.qr, firstScanData.time],
        [secondScanData.carNum, secondScanData.driverName, secondScanData.phone,
         secondScanData.ton, secondScanData.step, secondScanData.qr, secondScanData.time]
    ];

    const ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "기록");
    XLSX.writeFile(wb, "차량기록.xlsx");
}
</script>

</body>
</html>
